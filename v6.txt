def add_quick_folder(self, folder_type):
        """æ·»import tkinter as tk
from tkinter import ttk, filedialog, messagebox, scrolledtext
import threading
import http.server
import socketserver
import os
import socket
import webbrowser
from urllib.parse import quote, unquote
import json
import sys
from pathlib import Path
import configparser
import hashlib
import time
import mimetypes
import zipfile
import tempfile
import shutil
from datetime import datetime

class FolderShareApp:
    def __init__(self, root):
        self.root = root
        self.root.title("å±€åŸŸç½‘æ–‡ä»¶å¤¹å…±äº«å·¥å…· v2.0")
        self.root.geometry("900x700")
        self.root.resizable(True, True)
        
        # è®¾ç½®åº”ç”¨å›¾æ ‡å’Œæ ·å¼
        self.setup_styles()
        
        # å…±äº«çŠ¶æ€
        self.is_sharing = False
        self.server = None
        self.server_thread = None
        self.shared_folders = []
        self.port = 8080
        self.access_password = ""
        self.enable_upload = False
        self.access_log = []
        self.config_file = "share_config.ini"
        
        # åŠ è½½é…ç½®
        self.load_config()
        
        # åˆ›å»ºGUI
        self.create_widgets()
        
        # ç»‘å®šçª—å£å…³é—­äº‹ä»¶
        self.root.protocol("WM_DELETE_WINDOW", self.on_closing)
    
    def setup_styles(self):
        """è®¾ç½®ç•Œé¢æ ·å¼"""
        style = ttk.Style()
        style.theme_use('clam')
        
        # é…ç½®é¢œè‰²ä¸»é¢˜
        style.configure('Title.TLabel', font=('Microsoft YaHei', 16, 'bold'))
        style.configure('Header.TLabel', font=('Microsoft YaHei', 10, 'bold'))
        style.configure('Status.TLabel', font=('Microsoft YaHei', 9))
    
    def create_widgets(self):
        """åˆ›å»ºä¸»ç•Œé¢æ§ä»¶"""
        # ä¸»æ ‡é¢˜
        title_label = ttk.Label(self.root, text="å±€åŸŸç½‘æ–‡ä»¶å¤¹å…±äº«å·¥å…· v2.0", style='Title.TLabel')
        title_label.pack(pady=10)
        
        # åˆ›å»ºä¸»æ¡†æ¶
        main_frame = ttk.Frame(self.root)
        main_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=5)
        
        # åˆ›å»ºNotebookï¼ˆé€‰é¡¹å¡ï¼‰
        notebook = ttk.Notebook(main_frame)
        notebook.pack(fill=tk.BOTH, expand=True)
        
        # æ–‡ä»¶å…±äº«é€‰é¡¹å¡
        self.create_share_tab(notebook)
        
        # å®‰å…¨è®¾ç½®é€‰é¡¹å¡
        self.create_security_tab(notebook)
        
        # è®¿é—®æ—¥å¿—é€‰é¡¹å¡
        self.create_log_tab(notebook)
        
        # è®¾ç½®é€‰é¡¹å¡
        self.create_settings_tab(notebook)
    
    def create_share_tab(self, notebook):
        """åˆ›å»ºæ–‡ä»¶å…±äº«é€‰é¡¹å¡"""
        share_frame = ttk.Frame(notebook)
        notebook.add(share_frame, text="æ–‡ä»¶å…±äº«")
        
        # å·¦ä¾§é¢æ¿ - æ–‡ä»¶å¤¹ç®¡ç†
        left_frame = ttk.LabelFrame(share_frame, text="æ–‡ä»¶å¤¹ç®¡ç†", padding=10)
        left_frame.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(0, 5), pady=5)
        
        # æ–‡ä»¶å¤¹åˆ—è¡¨
        folders_label = ttk.Label(left_frame, text="å·²é€‰æ‹©çš„å…±äº«æ–‡ä»¶å¤¹:", style='Header.TLabel')
        folders_label.pack(anchor=tk.W, pady=(0, 5))
        
        # æ–‡ä»¶å¤¹åˆ—è¡¨æ¡†æ¶
        list_frame = ttk.Frame(left_frame)
        list_frame.pack(fill=tk.BOTH, expand=True, pady=(0, 10))
        
        # æ–‡ä»¶å¤¹åˆ—è¡¨
        self.folders_listbox = tk.Listbox(list_frame, selectmode=tk.SINGLE, font=('Consolas', 9))
        scrollbar = ttk.Scrollbar(list_frame, orient=tk.VERTICAL, command=self.folders_listbox.yview)
        self.folders_listbox.configure(yscrollcommand=scrollbar.set)
        
        self.folders_listbox.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
        
        # æŒ‰é’®æ¡†æ¶
        btn_frame = ttk.Frame(left_frame)
        btn_frame.pack(fill=tk.X, pady=(0, 10))
        
        self.add_btn = ttk.Button(btn_frame, text="æ·»åŠ æ–‡ä»¶å¤¹", command=self.add_folder)
        self.add_btn.pack(side=tk.LEFT, padx=(0, 5))
        
        self.remove_btn = ttk.Button(btn_frame, text="ç§»é™¤é€‰ä¸­", command=self.remove_folder)
        self.remove_btn.pack(side=tk.LEFT, padx=(0, 5))
        
        self.clear_btn = ttk.Button(btn_frame, text="æ¸…ç©ºåˆ—è¡¨", command=self.clear_folders)
        self.clear_btn.pack(side=tk.LEFT)
        
        # å¿«æ·æ“ä½œ
        quick_frame = ttk.LabelFrame(left_frame, text="å¿«æ·æ“ä½œ", padding=5)
        quick_frame.pack(fill=tk.X, pady=(10, 0))
        
        quick_btn_frame = ttk.Frame(quick_frame)
        quick_btn_frame.pack(fill=tk.X)
        
        ttk.Button(quick_btn_frame, text="æ·»åŠ æ¡Œé¢", command=lambda: self.add_quick_folder("Desktop")).pack(side=tk.LEFT, padx=(0, 5))
        ttk.Button(quick_btn_frame, text="æ·»åŠ æ–‡æ¡£", command=lambda: self.add_quick_folder("Documents")).pack(side=tk.LEFT, padx=(0, 5))
        ttk.Button(quick_btn_frame, text="æ·»åŠ ä¸‹è½½", command=lambda: self.add_quick_folder("Downloads")).pack(side=tk.LEFT)
        
        # å³ä¾§é¢æ¿ - æ§åˆ¶å’ŒçŠ¶æ€
        right_frame = ttk.LabelFrame(share_frame, text="æ§åˆ¶é¢æ¿", padding=10)
        right_frame.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True, padx=(5, 0), pady=5)
        
        # æœåŠ¡å™¨è®¾ç½®
        server_frame = ttk.LabelFrame(right_frame, text="æœåŠ¡å™¨è®¾ç½®", padding=10)
        server_frame.pack(fill=tk.X, pady=(0, 10))
        
        # ç«¯å£è®¾ç½®
        port_frame = ttk.Frame(server_frame)
        port_frame.pack(fill=tk.X, pady=(0, 5))
        
        ttk.Label(port_frame, text="ç«¯å£å·:").pack(side=tk.LEFT)
        self.port_var = tk.StringVar(value=str(self.port))
        port_entry = ttk.Entry(port_frame, textvariable=self.port_var, width=8)
        port_entry.pack(side=tk.LEFT, padx=(5, 10))
        
        # ä¸Šä¼ åŠŸèƒ½å¼€å…³
        self.upload_var = tk.BooleanVar(value=self.enable_upload)
        upload_check = ttk.Checkbutton(server_frame, text="å…è®¸ä¸Šä¼ æ–‡ä»¶", variable=self.upload_var)
        upload_check.pack(anchor=tk.W, pady=(0, 5))
        
        # æ§åˆ¶æŒ‰é’®
        control_frame = ttk.Frame(server_frame)
        control_frame.pack(fill=tk.X)
        
        self.start_btn = ttk.Button(control_frame, text="ğŸš€ å¼€å§‹å…±äº«", command=self.start_sharing)
        self.start_btn.pack(side=tk.LEFT, padx=(0, 5))
        
        self.stop_btn = ttk.Button(control_frame, text="â¹ï¸ åœæ­¢å…±äº«", command=self.stop_sharing, state=tk.DISABLED)
        self.stop_btn.pack(side=tk.LEFT, padx=(0, 5))
        
        self.open_btn = ttk.Button(control_frame, text="ğŸŒ æ‰“å¼€æµè§ˆå™¨", command=self.open_browser, state=tk.DISABLED)
        self.open_btn.pack(side=tk.LEFT)
        
        # çŠ¶æ€ä¿¡æ¯
        status_frame = ttk.LabelFrame(right_frame, text="çŠ¶æ€ä¿¡æ¯", padding=10)
        status_frame.pack(fill=tk.BOTH, expand=True)
        
        # çŠ¶æ€æ˜¾ç¤º
        self.status_var = tk.StringVar(value="å°±ç»ª")
        status_label = ttk.Label(status_frame, text="çŠ¶æ€:", style='Header.TLabel')
        status_label.pack(anchor=tk.W)
        
        self.status_display = ttk.Label(status_frame, textvariable=self.status_var, style='Status.TLabel')
        self.status_display.pack(anchor=tk.W, pady=(0, 10))
        
        # IPåœ°å€æ˜¾ç¤º
        ip_label = ttk.Label(status_frame, text="æœ¬æœºIPåœ°å€:", style='Header.TLabel')
        ip_label.pack(anchor=tk.W)
        
        self.ip_var = tk.StringVar(value=self.get_local_ip())
        ip_display = ttk.Label(status_frame, textvariable=self.ip_var, style='Status.TLabel')
        ip_display.pack(anchor=tk.W, pady=(0, 10))
        
        # è®¿é—®åœ°å€æ˜¾ç¤º
        self.url_label = ttk.Label(status_frame, text="è®¿é—®åœ°å€:", style='Header.TLabel')
        self.url_label.pack(anchor=tk.W)
        
        self.url_var = tk.StringVar(value="æœªå¯åŠ¨æœåŠ¡")
        self.url_display = ttk.Label(status_frame, textvariable=self.url_var, style='Status.TLabel', foreground='blue', cursor='hand2')
        self.url_display.pack(anchor=tk.W, pady=(0, 10))
        self.url_display.bind("<Button-1>", lambda e: self.open_browser())
        
        # å®æ—¶ç»Ÿè®¡
        stats_label = ttk.Label(status_frame, text="è®¿é—®ç»Ÿè®¡:", style='Header.TLabel')
        stats_label.pack(anchor=tk.W)
        
        self.stats_var = tk.StringVar(value="è®¿é—®æ¬¡æ•°: 0 | ä¸‹è½½æ¬¡æ•°: 0")
        stats_display = ttk.Label(status_frame, textvariable=self.stats_var, style='Status.TLabel')
        stats_display.pack(anchor=tk.W, pady=(0, 10))
        
        # è¿è¡Œæ—¥å¿—
        log_label = ttk.Label(status_frame, text="è¿è¡Œæ—¥å¿—:", style='Header.TLabel')
        log_label.pack(anchor=tk.W)
        
        self.log_text = scrolledtext.ScrolledText(status_frame, height=10, width=35, font=('Consolas', 8))
        self.log_text.pack(fill=tk.BOTH, expand=True)
        
        self.log("ç¨‹åºå¯åŠ¨å®Œæˆ")
        self.log(f"æœ¬æœºIPåœ°å€: {self.get_local_ip()}")
    
    def create_security_tab(self, notebook):
        """åˆ›å»ºå®‰å…¨è®¾ç½®é€‰é¡¹å¡"""
        security_frame = ttk.Frame(notebook)
        notebook.add(security_frame, text="å®‰å…¨è®¾ç½®")
        
        # å¯†ç ä¿æŠ¤
        password_frame = ttk.LabelFrame(security_frame, text="è®¿é—®å¯†ç ä¿æŠ¤", padding=15)
        password_frame.pack(fill=tk.X, padx=10, pady=10)
        
        self.password_enabled_var = tk.BooleanVar(value=bool(self.access_password))
        password_check = ttk.Checkbutton(password_frame, text="å¯ç”¨å¯†ç ä¿æŠ¤", variable=self.password_enabled_var, command=self.toggle_password)
        password_check.pack(anchor=tk.W, pady=(0, 10))
        
        password_input_frame = ttk.Frame(password_frame)
        password_input_frame.pack(fill=tk.X)
        
        ttk.Label(password_input_frame, text="è®¿é—®å¯†ç :").pack(side=tk.LEFT)
        self.password_var = tk.StringVar(value=self.access_password)
        self.password_entry = ttk.Entry(password_input_frame, textvariable=self.password_var, show="*", width=20)
        self.password_entry.pack(side=tk.LEFT, padx=(10, 5))
        
        ttk.Button(password_input_frame, text="ç”Ÿæˆéšæœºå¯†ç ", command=self.generate_password).pack(side=tk.LEFT, padx=(5, 0))
        
        # IPè®¿é—®æ§åˆ¶
        ip_frame = ttk.LabelFrame(security_frame, text="IPè®¿é—®æ§åˆ¶", padding=15)
        ip_frame.pack(fill=tk.X, padx=10, pady=10)
        
        self.ip_filter_var = tk.BooleanVar()
        ip_check = ttk.Checkbutton(ip_frame, text="å¯ç”¨IPç™½åå•", variable=self.ip_filter_var)
        ip_check.pack(anchor=tk.W, pady=(0, 10))
        
        ttk.Label(ip_frame, text="å…è®¸è®¿é—®çš„IPåœ°å€ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰:").pack(anchor=tk.W)
        self.ip_list_text = scrolledtext.ScrolledText(ip_frame, height=6, width=50)
        self.ip_list_text.pack(fill=tk.X, pady=(5, 0))
        self.ip_list_text.insert(tk.END, "192.168.1.0/24\n127.0.0.1\n")
        
        # è®¿é—®é™åˆ¶
        limit_frame = ttk.LabelFrame(security_frame, text="è®¿é—®é™åˆ¶", padding=15)
        limit_frame.pack(fill=tk.X, padx=10, pady=10)
        
        # æœ€å¤§è¿æ¥æ•°
        conn_frame = ttk.Frame(limit_frame)
        conn_frame.pack(fill=tk.X, pady=(0, 10))
        
        ttk.Label(conn_frame, text="æœ€å¤§åŒæ—¶è¿æ¥æ•°:").pack(side=tk.LEFT)
        self.max_connections_var = tk.StringVar(value="10")
        ttk.Entry(conn_frame, textvariable=self.max_connections_var, width=5).pack(side=tk.LEFT, padx=(10, 0))
        
        # ä¸‹è½½é€Ÿåº¦é™åˆ¶
        speed_frame = ttk.Frame(limit_frame)
        speed_frame.pack(fill=tk.X)
        
        ttk.Label(speed_frame, text="ä¸‹è½½é€Ÿåº¦é™åˆ¶ (KB/s):").pack(side=tk.LEFT)
        self.speed_limit_var = tk.StringVar(value="0")
        ttk.Entry(speed_frame, textvariable=self.speed_limit_var, width=8).pack(side=tk.LEFT, padx=(10, 5))
        ttk.Label(speed_frame, text="(0è¡¨ç¤ºæ— é™åˆ¶)").pack(side=tk.LEFT)
    
    def create_log_tab(self, notebook):
        """åˆ›å»ºè®¿é—®æ—¥å¿—é€‰é¡¹å¡"""
        log_frame = ttk.Frame(notebook)
        notebook.add(log_frame, text="è®¿é—®æ—¥å¿—")
        
        # æ—¥å¿—æ§åˆ¶
        control_frame = ttk.Frame(log_frame)
        control_frame.pack(fill=tk.X, padx=10, pady=10)
        
        ttk.Button(control_frame, text="ğŸ”„ åˆ·æ–°æ—¥å¿—", command=self.refresh_access_log).pack(side=tk.LEFT, padx=(0, 10))
        ttk.Button(control_frame, text="ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—", command=self.clear_access_log).pack(side=tk.LEFT, padx=(0, 10))
        ttk.Button(control_frame, text="ğŸ’¾ å¯¼å‡ºæ—¥å¿—", command=self.export_access_log).pack(side=tk.LEFT)
        
        # æ—¥å¿—æ˜¾ç¤º
        log_display_frame = ttk.LabelFrame(log_frame, text="è®¿é—®è®°å½•", padding=10)
        log_display_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=(0, 10))
        
        # åˆ›å»ºTreeviewæ˜¾ç¤ºæ—¥å¿—
        columns = ("æ—¶é—´", "IPåœ°å€", "æ“ä½œ", "è·¯å¾„", "çŠ¶æ€")
        self.access_log_tree = ttk.Treeview(log_display_frame, columns=columns, show="headings", height=15)
        
        for col in columns:
            self.access_log_tree.heading(col, text=col)
            self.access_log_tree.column(col, width=120 if col == "æ—¶é—´" else 100)
        
        log_scrollbar = ttk.Scrollbar(log_display_frame, orient=tk.VERTICAL, command=self.access_log_tree.yview)
        self.access_log_tree.configure(yscrollcommand=log_scrollbar.set)
        
        self.access_log_tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        log_scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
    
    def create_settings_tab(self, notebook):
        """åˆ›å»ºè®¾ç½®é€‰é¡¹å¡"""
        settings_frame = ttk.Frame(notebook)
        notebook.add(settings_frame, text="è®¾ç½®")
        
        # ç•Œé¢è®¾ç½®
        ui_frame = ttk.LabelFrame(settings_frame, text="ç•Œé¢è®¾ç½®", padding=15)
        ui_frame.pack(fill=tk.X, padx=10, pady=10)
        
        # ä¸»é¢˜é€‰æ‹©
        theme_frame = ttk.Frame(ui_frame)
        theme_frame.pack(fill=tk.X, pady=(0, 10))
        
        ttk.Label(theme_frame, text="ç•Œé¢ä¸»é¢˜:").pack(side=tk.LEFT)
        self.theme_var = tk.StringVar(value="é»˜è®¤")
        theme_combo = ttk.Combobox(theme_frame, textvariable=self.theme_var, values=["é»˜è®¤", "æ·±è‰²", "æµ…è‰²"], state="readonly", width=10)
        theme_combo.pack(side=tk.LEFT, padx=(10, 0))
        
        # è‡ªåŠ¨ä¿å­˜è®¾ç½®
        self.auto_save_var = tk.BooleanVar(value=True)
        ttk.Checkbutton(ui_frame, text="è‡ªåŠ¨ä¿å­˜é…ç½®", variable=self.auto_save_var).pack(anchor=tk.W)
        
        # å¯åŠ¨è®¾ç½®
        startup_frame = ttk.LabelFrame(settings_frame, text="å¯åŠ¨è®¾ç½®", padding=15)
        startup_frame.pack(fill=tk.X, padx=10, pady=10)
        
        self.auto_start_var = tk.BooleanVar()
        ttk.Checkbutton(startup_frame, text="ç¨‹åºå¯åŠ¨æ—¶è‡ªåŠ¨å¼€å§‹å…±äº«", variable=self.auto_start_var).pack(anchor=tk.W, pady=(0, 5))
        
        self.minimize_start_var = tk.BooleanVar()
        ttk.Checkbutton(startup_frame, text="å¯åŠ¨æ—¶æœ€å°åŒ–åˆ°ç³»ç»Ÿæ‰˜ç›˜", variable=self.minimize_start_var).pack(anchor=tk.W, pady=(0, 5))
        
        self.remember_folders_var = tk.BooleanVar(value=True)
        ttk.Checkbutton(startup_frame, text="è®°ä½ä¸Šæ¬¡çš„å…±äº«æ–‡ä»¶å¤¹", variable=self.remember_folders_var).pack(anchor=tk.W)
        
        # é«˜çº§è®¾ç½®
        advanced_frame = ttk.LabelFrame(settings_frame, text="é«˜çº§è®¾ç½®", padding=15)
        advanced_frame.pack(fill=tk.X, padx=10, pady=10)
        
        # ç¼“å­˜è®¾ç½®
        cache_frame = ttk.Frame(advanced_frame)
        cache_frame.pack(fill=tk.X, pady=(0, 10))
        
        ttk.Label(cache_frame, text="æ–‡ä»¶åˆ—è¡¨ç¼“å­˜æ—¶é—´(ç§’):").pack(side=tk.LEFT)
        self.cache_time_var = tk.StringVar(value="30")
        ttk.Entry(cache_frame, textvariable=self.cache_time_var, width=5).pack(side=tk.LEFT, padx=(10, 0))
        
        # å‹ç¼©ä¸‹è½½
        self.enable_zip_var = tk.BooleanVar(value=True)
        ttk.Checkbutton(advanced_frame, text="å¯ç”¨æ–‡ä»¶å¤¹å‹ç¼©ä¸‹è½½", variable=self.enable_zip_var).pack(anchor=tk.W, pady=(0, 5))
        
        # æ“ä½œæŒ‰é’®
        btn_frame = ttk.Frame(settings_frame)
        btn_frame.pack(fill=tk.X, padx=10, pady=20)
        
        ttk.Button(btn_frame, text="ğŸ’¾ ä¿å­˜é…ç½®", command=self.save_config).pack(side=tk.LEFT, padx=(0, 10))
        ttk.Button(btn_frame, text="ğŸ”„ é‡ç½®é…ç½®", command=self.reset_config).pack(side=tk.LEFT, padx=(0, 10))
        ttk.Button(btn_frame, text="ğŸ“ æ‰“å¼€é…ç½®æ–‡ä»¶å¤¹", command=self.open_config_folder).pack(side=tk.LEFT)
        """è·å–æœ¬æœºIPåœ°å€"""
        try:
            # è¿æ¥åˆ°ä¸€ä¸ªè¿œç¨‹åœ°å€æ¥è·å–æœ¬æœºIP
            s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
            s.connect(("8.8.8.8", 80))
            ip = s.getsockname()[0]
            s.close()
            return ip
        except:
            return "127.0.0.1"
    
    def log(self, message):
        """æ·»åŠ æ—¥å¿—ä¿¡æ¯"""
        import datetime
        timestamp = datetime.datetime.now().strftime("%H:%M:%S")
        log_message = f"[{timestamp}] {message}\n"
        
        self.log_text.insert(tk.END, log_message)
        self.log_text.see(tk.END)
        self.root.update_idletasks()
    
    def add_folder(self):
        """æ·»åŠ æ–‡ä»¶å¤¹åˆ°å…±äº«åˆ—è¡¨"""
        if self.is_sharing:
            messagebox.showwarning("è­¦å‘Š", "è¯·å…ˆåœæ­¢å…±äº«åå†æ·»åŠ æ–‡ä»¶å¤¹")
            return
        
        folder_path = filedialog.askdirectory(title="é€‰æ‹©è¦å…±äº«çš„æ–‡ä»¶å¤¹")
        if folder_path:
            if folder_path not in self.shared_folders:
                self.shared_folders.append(folder_path)
                self.folders_listbox.insert(tk.END, folder_path)
                self.log(f"æ·»åŠ å…±äº«æ–‡ä»¶å¤¹: {folder_path}")
            else:
                messagebox.showinfo("æç¤º", "è¯¥æ–‡ä»¶å¤¹å·²ç»åœ¨å…±äº«åˆ—è¡¨ä¸­")
    
    def remove_folder(self):
        """ç§»é™¤é€‰ä¸­çš„æ–‡ä»¶å¤¹"""
        if self.is_sharing:
            messagebox.showwarning("è­¦å‘Š", "è¯·å…ˆåœæ­¢å…±äº«åå†ç§»é™¤æ–‡ä»¶å¤¹")
            return
        
        selection = self.folders_listbox.curselection()
        if selection:
            index = selection[0]
            folder_path = self.shared_folders[index]
            self.shared_folders.pop(index)
            self.folders_listbox.delete(index)
            self.log(f"ç§»é™¤å…±äº«æ–‡ä»¶å¤¹: {folder_path}")
        else:
            messagebox.showinfo("æç¤º", "è¯·å…ˆé€‰æ‹©è¦ç§»é™¤çš„æ–‡ä»¶å¤¹")
    
    def clear_folders(self):
        """æ¸…ç©ºæ–‡ä»¶å¤¹åˆ—è¡¨"""
        if self.is_sharing:
            messagebox.showwarning("è­¦å‘Š", "è¯·å…ˆåœæ­¢å…±äº«åå†æ¸…ç©ºåˆ—è¡¨")
            return
        
        if self.shared_folders:
            self.shared_folders.clear()
            self.folders_listbox.delete(0, tk.END)
            self.log("æ¸…ç©ºå…±äº«æ–‡ä»¶å¤¹åˆ—è¡¨")
    
    def start_sharing(self):
        """å¼€å§‹å…±äº«"""
        if not self.shared_folders:
            messagebox.showwarning("è­¦å‘Š", "è¯·å…ˆæ·»åŠ è¦å…±äº«çš„æ–‡ä»¶å¤¹")
            return
        
        try:
            self.port = int(self.port_var.get())
            if self.port < 1024 or self.port > 65535:
                raise ValueError("ç«¯å£å·èŒƒå›´åº”ä¸º1024-65535")
        except ValueError as e:
            messagebox.showerror("é”™è¯¯", f"ç«¯å£å·è®¾ç½®é”™è¯¯: {e}")
            return
        
        try:
            # åˆ›å»ºHTTPæœåŠ¡å™¨
            self.server = CustomHTTPServer(('', self.port), CustomHTTPRequestHandler)
            self.server.shared_folders = self.shared_folders
            self.server.app_ref = self
            
            # åœ¨æ–°çº¿ç¨‹ä¸­å¯åŠ¨æœåŠ¡å™¨
            self.server_thread = threading.Thread(target=self.server.serve_forever, daemon=True)
            self.server_thread.start()
            
            self.is_sharing = True
            self.start_btn.config(state=tk.DISABLED)
            self.stop_btn.config(state=tk.NORMAL)
            self.open_btn.config(state=tk.NORMAL)
            
            url = f"http://{self.get_local_ip()}:{self.port}"
            self.url_var.set(url)
            self.status_var.set("å…±äº«ä¸­...")
            
            self.log(f"å¼€å§‹å…±äº«æœåŠ¡ï¼Œç«¯å£: {self.port}")
            self.log(f"è®¿é—®åœ°å€: {url}")
            self.log(f"å…±äº«æ–‡ä»¶å¤¹æ•°é‡: {len(self.shared_folders)}")
            
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"å¯åŠ¨å…±äº«æœåŠ¡å¤±è´¥: {e}")
            self.log(f"å¯åŠ¨å¤±è´¥: {e}")
    
    def stop_sharing(self):
        """åœæ­¢å…±äº«"""
        if self.server:
            self.server.shutdown()
            self.server = None
        
        if self.server_thread:
            self.server_thread = None
        
        self.is_sharing = False
        self.start_btn.config(state=tk.NORMAL)
        self.stop_btn.config(state=tk.DISABLED)
        self.open_btn.config(state=tk.DISABLED)
        
        self.url_var.set("æœªå¯åŠ¨æœåŠ¡")
        self.status_var.set("å·²åœæ­¢")
        
        self.log("åœæ­¢å…±äº«æœåŠ¡")
    
    def open_browser(self):
        """æ‰“å¼€æµè§ˆå™¨è®¿é—®å…±äº«"""
        if self.is_sharing:
            url = f"http://{self.get_local_ip()}:{self.port}"
            webbrowser.open(url)
            self.log("æ‰“å¼€æµè§ˆå™¨è®¿é—®å…±äº«")
    
    def on_closing(self):
        """ç¨‹åºå…³é—­æ—¶çš„å¤„ç†"""
        if self.is_sharing:
            self.stop_sharing()
        self.root.destroy()

class CustomHTTPServer(socketserver.TCPServer):
    allow_reuse_address = True

class CustomHTTPRequestHandler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        """å¤„ç†GETè¯·æ±‚"""
        try:
            if self.path == '/' or self.path == '':
                self.send_folder_list()
            elif self.path.startswith('/folder/'):
                folder_index = int(self.path.split('/')[2])
                if 0 <= folder_index < len(self.server.shared_folders):
                    self.browse_folder(self.server.shared_folders[folder_index])
                else:
                    self.send_error(404, "æ–‡ä»¶å¤¹ä¸å­˜åœ¨")
            elif self.path.startswith('/download/'):
                parts = self.path.split('/', 3)
                if len(parts) >= 4:
                    folder_index = int(parts[2])
                    file_path = parts[3]
                    if 0 <= folder_index < len(self.server.shared_folders):
                        full_path = os.path.join(self.server.shared_folders[folder_index], file_path)
                        self.download_file(full_path)
                    else:
                        self.send_error(404, "æ–‡ä»¶ä¸å­˜åœ¨")
                else:
                    self.send_error(404, "è·¯å¾„é”™è¯¯")
            else:
                self.send_error(404, "é¡µé¢ä¸å­˜åœ¨")
        except Exception as e:
            self.server.app_ref.log(f"è¯·æ±‚å¤„ç†é”™è¯¯: {e}")
            self.send_error(500, f"æœåŠ¡å™¨é”™è¯¯: {e}")
    
    def send_folder_list(self):
        """å‘é€æ–‡ä»¶å¤¹åˆ—è¡¨é¡µé¢"""
        html = """
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>å±€åŸŸç½‘æ–‡ä»¶å…±äº«</title>
            <style>
                body { font-family: 'Microsoft YaHei', Arial, sans-serif; margin: 40px; background: #f5f5f5; }
                .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                h1 { color: #333; text-align: center; margin-bottom: 30px; }
                .folder-item { background: #f8f9fa; margin: 10px 0; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff; }
                .folder-item:hover { background: #e9ecef; }
                .folder-name { font-weight: bold; color: #007bff; text-decoration: none; font-size: 16px; }
                .folder-path { color: #6c757d; font-size: 12px; margin-top: 5px; }
                .footer { text-align: center; margin-top: 30px; color: #6c757d; font-size: 12px; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ğŸ“ å±€åŸŸç½‘æ–‡ä»¶å…±äº«</h1>
        """
        
        for i, folder in enumerate(self.server.shared_folders):
            folder_name = os.path.basename(folder)
            html += f'''
                <div class="folder-item">
                    <a href="/folder/{i}" class="folder-name">ğŸ“‚ {folder_name}</a>
                    <div class="folder-path">è·¯å¾„: {folder}</div>
                </div>
            '''
        
        html += """
                <div class="footer">
                    <p>å±€åŸŸç½‘æ–‡ä»¶å¤¹å…±äº«å·¥å…· | è¯·åœ¨åŒä¸€ç½‘ç»œç¯å¢ƒä¸‹è®¿é—®</p>
                </div>
            </div>
        </body>
        </html>
        """
        
        self.send_response(200)
        self.send_header('Content-type', 'text/html; charset=utf-8')
        self.end_headers()
        self.wfile.write(html.encode('utf-8'))
    
    def browse_folder(self, folder_path, sub_path=""):
        """æµè§ˆæ–‡ä»¶å¤¹å†…å®¹"""
        current_path = os.path.join(folder_path, sub_path) if sub_path else folder_path
        
        if not os.path.exists(current_path):
            self.send_error(404, "è·¯å¾„ä¸å­˜åœ¨")
            return
        
        folder_index = self.server.shared_folders.index(folder_path)
        folder_name = os.path.basename(folder_path)
        
        html = f"""
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>{folder_name} - æ–‡ä»¶æµè§ˆ</title>
            <style>
                body {{ font-family: 'Microsoft YaHei', Arial, sans-serif; margin: 20px; background: #f5f5f5; }}
                .container {{ max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
                .header {{ margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #007bff; }}
                .breadcrumb {{ background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 20px; }}
                .breadcrumb a {{ color: #007bff; text-decoration: none; }}
                .breadcrumb a:hover {{ text-decoration: underline; }}
                .file-list {{ }}
                .file-item {{ display: flex; align-items: center; padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; }}
                .file-item:hover {{ background: #e9ecef; }}
                .file-icon {{ margin-right: 10px; font-size: 20px; }}
                .file-info {{ flex-grow: 1; }}
                .file-name {{ font-weight: bold; color: #333; text-decoration: none; }}
                .file-name:hover {{ color: #007bff; }}
                .file-size {{ color: #6c757d; font-size: 12px; }}
                .download-btn {{ background: #007bff; color: white; padding: 5px 10px; border: none; border-radius: 3px; text-decoration: none; font-size: 12px; }}
                .download-btn:hover {{ background: #0056b3; }}
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>ğŸ“ {folder_name}</h1>
                </div>
                
                <div class="breadcrumb">
                    <a href="/">ğŸ  é¦–é¡µ</a> / 
                    <a href="/folder/{folder_index}">ğŸ“‚ {folder_name}</a>
        """
        
        # æ·»åŠ é¢åŒ…å±‘å¯¼èˆª
        if sub_path:
            parts = sub_path.split('/')
            current_sub = ""
            for part in parts:
                if part:
                    current_sub = os.path.join(current_sub, part).replace('\\', '/')
                    html += f' / <a href="/folder/{folder_index}?path={quote(current_sub)}">ğŸ“ {part}</a>'
        
        html += """
                </div>
                
                <div class="file-list">
        """
        
        # å¦‚æœä¸æ˜¯æ ¹ç›®å½•ï¼Œæ·»åŠ è¿”å›ä¸Šçº§ç›®å½•é“¾æ¥
        if sub_path:
            parent_path = '/'.join(sub_path.split('/')[:-1]) if '/' in sub_path else ""
            parent_url = f"/folder/{folder_index}"
            if parent_path:
                parent_url += f"?path={quote(parent_path)}"
            
            html += f'''
                <div class="file-item">
                    <div class="file-icon">â¬†ï¸</div>
                    <div class="file-info">
                        <a href="{parent_url}" class="file-name">.. (è¿”å›ä¸Šçº§ç›®å½•)</a>
                    </div>
                </div>
            '''
        
        # åˆ—å‡ºç›®å½•å†…å®¹
        try:
            items = os.listdir(current_path)
            items.sort()
            
            # å…ˆæ˜¾ç¤ºæ–‡ä»¶å¤¹
            for item in items:
                item_path = os.path.join(current_path, item)
                if os.path.isdir(item_path):
                    new_sub_path = os.path.join(sub_path, item).replace('\\', '/') if sub_path else item
                    html += f'''
                        <div class="file-item">
                            <div class="file-icon">ğŸ“</div>
                            <div class="file-info">
                                <a href="/folder/{folder_index}?path={quote(new_sub_path)}" class="file-name">{item}</a>
                                <div class="file-size">æ–‡ä»¶å¤¹</div>
                            </div>
                        </div>
                    '''
            
            # å†æ˜¾ç¤ºæ–‡ä»¶
            for item in items:
                item_path = os.path.join(current_path, item)
                if os.path.isfile(item_path):
                    file_size = self.format_file_size(os.path.getsize(item_path))
                    download_path = os.path.join(sub_path, item).replace('\\', '/') if sub_path else item
                    
                    html += f'''
                        <div class="file-item">
                            <div class="file-icon">ğŸ“„</div>
                            <div class="file-info">
                                <div class="file-name">{item}</div>
                                <div class="file-size">{file_size}</div>
                            </div>
                            <a href="/download/{folder_index}/{quote(download_path)}" class="download-btn">ä¸‹è½½</a>
                        </div>
                    '''
        
        except PermissionError:
            html += '<div class="file-item"><div class="file-info">âŒ æƒé™ä¸è¶³ï¼Œæ— æ³•è®¿é—®æ­¤ç›®å½•</div></div>'
        
        html += """
                </div>
            </div>
        </body>
        </html>
        """
        
        self.send_response(200)
        self.send_header('Content-type', 'text/html; charset=utf-8')
        self.end_headers()
        self.wfile.write(html.encode('utf-8'))
    
    def download_file(self, file_path):
        """ä¸‹è½½æ–‡ä»¶"""
        if not os.path.exists(file_path) or not os.path.isfile(file_path):
            self.send_error(404, "æ–‡ä»¶ä¸å­˜åœ¨")
            return
        
        try:
            file_size = os.path.getsize(file_path)
            filename = os.path.basename(file_path)
            
            self.send_response(200)
            self.send_header('Content-Type', 'application/octet-stream')
            self.send_header('Content-Disposition', f'attachment; filename*=UTF-8\'\'{quote(filename)}')
            self.send_header('Content-Length', str(file_size))
            self.end_headers()
            
            # è®°å½•ä¸‹è½½æ—¥å¿—
            self.server.app_ref.log(f"ä¸‹è½½æ–‡ä»¶: {filename}")
            
            with open(file_path, 'rb') as f:
                while True:
                    data = f.read(8192)
                    if not data:
                        break
                    self.wfile.write(data)
        
        except Exception as e:
            self.server.app_ref.log(f"æ–‡ä»¶ä¸‹è½½é”™è¯¯: {e}")
            self.send_error(500, f"ä¸‹è½½å¤±è´¥: {e}")
    
    def format_file_size(self, size):
        """æ ¼å¼åŒ–æ–‡ä»¶å¤§å°"""
        for unit in ['B', 'KB', 'MB', 'GB']:
            if size < 1024.0:
                return f"{size:.1f} {unit}"
            size /= 1024.0
        return f"{size:.1f} TB"
    
    def log_message(self, format, *args):
        """é‡å†™æ—¥å¿—æ–¹æ³•ï¼Œå°†HTTPæ—¥å¿—å‘é€åˆ°GUI"""
        message = format % args
        if hasattr(self.server, 'app_ref'):
            self.server.app_ref.log(f"HTTP: {message}")

def main():
    # è®¾ç½®çª—å£DPIæ„ŸçŸ¥ï¼ˆWindows 10/11ï¼‰
    try:
        from ctypes import windll
        windll.shcore.SetProcessDpiAwareness(1)
    except:
        pass
    
    root = tk.Tk()
    app = FolderShareApp(root)
    root.mainloop()

if __name__ == "__main__":
    main()