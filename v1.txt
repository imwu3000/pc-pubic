import tkinter as tk
from tkinter import ttk, filedialog, messagebox, scrolledtext
import threading
import http.server
import socketserver
import os
import socket
import webbrowser
from urllib.parse import quote
import json
import sys
from pathlib import Path

class FolderShareApp:
    def __init__(self, root):
        self.root = root
        self.root.title("å±€åŸŸç½‘æ–‡ä»¶å¤¹å…±äº«å·¥å…· v1.0")
        self.root.geometry("800x600")
        self.root.resizable(True, True)
        
        # è®¾ç½®åº”ç”¨å›¾æ ‡å’Œæ ·å¼
        self.setup_styles()
        
        # å…±äº«çŠ¶æ€
        self.is_sharing = False
        self.server = None
        self.server_thread = None
        self.shared_folders = []
        self.port = 8080
        
        # åˆ›å»ºGUI
        self.create_widgets()
        
        # ç»‘å®šçª—å£å…³é—­äº‹ä»¶
        self.root.protocol("WM_DELETE_WINDOW", self.on_closing)
    
    def setup_styles(self):
        """è®¾ç½®ç•Œé¢æ ·å¼"""
        style = ttk.Style()
        style.theme_use('clam')
        
        # é…ç½®é¢œè‰²ä¸»é¢˜
        style.configure('Title.TLabel', font=('Microsoft YaHei', 16, 'bold'))
        style.configure('Header.TLabel', font=('Microsoft YaHei', 10, 'bold'))
        style.configure('Status.TLabel', font=('Microsoft YaHei', 9))
    
    def create_widgets(self):
        """åˆ›å»ºä¸»ç•Œé¢æ§ä»¶"""
        # ä¸»æ ‡é¢˜
        title_label = ttk.Label(self.root, text="å±€åŸŸç½‘æ–‡ä»¶å¤¹å…±äº«å·¥å…·", style='Title.TLabel')
        title_label.pack(pady=10)
        
        # åˆ›å»ºä¸»æ¡†æ¶
        main_frame = ttk.Frame(self.root)
        main_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=5)
        
        # å·¦ä¾§é¢æ¿ - æ–‡ä»¶å¤¹ç®¡ç†
        left_frame = ttk.LabelFrame(main_frame, text="æ–‡ä»¶å¤¹ç®¡ç†", padding=10)
        left_frame.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(0, 5))
        
        # æ–‡ä»¶å¤¹åˆ—è¡¨
        folders_label = ttk.Label(left_frame, text="å·²é€‰æ‹©çš„å…±äº«æ–‡ä»¶å¤¹:", style='Header.TLabel')
        folders_label.pack(anchor=tk.W, pady=(0, 5))
        
        # æ–‡ä»¶å¤¹åˆ—è¡¨æ¡†æ¶
        list_frame = ttk.Frame(left_frame)
        list_frame.pack(fill=tk.BOTH, expand=True, pady=(0, 10))
        
        # æ–‡ä»¶å¤¹åˆ—è¡¨
        self.folders_listbox = tk.Listbox(list_frame, selectmode=tk.SINGLE, font=('Consolas', 9))
        scrollbar = ttk.Scrollbar(list_frame, orient=tk.VERTICAL, command=self.folders_listbox.yview)
        self.folders_listbox.configure(yscrollcommand=scrollbar.set)
        
        self.folders_listbox.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
        
        # æŒ‰é’®æ¡†æ¶
        btn_frame = ttk.Frame(left_frame)
        btn_frame.pack(fill=tk.X, pady=(0, 10))
        
        self.add_btn = ttk.Button(btn_frame, text="æ·»åŠ æ–‡ä»¶å¤¹", command=self.add_folder)
        self.add_btn.pack(side=tk.LEFT, padx=(0, 5))
        
        self.remove_btn = ttk.Button(btn_frame, text="ç§»é™¤é€‰ä¸­", command=self.remove_folder)
        self.remove_btn.pack(side=tk.LEFT, padx=(0, 5))
        
        self.clear_btn = ttk.Button(btn_frame, text="æ¸…ç©ºåˆ—è¡¨", command=self.clear_folders)
        self.clear_btn.pack(side=tk.LEFT)
        
        # ç«¯å£è®¾ç½®
        port_frame = ttk.Frame(left_frame)
        port_frame.pack(fill=tk.X, pady=(0, 10))
        
        ttk.Label(port_frame, text="ç«¯å£å·:").pack(side=tk.LEFT)
        self.port_var = tk.StringVar(value=str(self.port))
        port_entry = ttk.Entry(port_frame, textvariable=self.port_var, width=8)
        port_entry.pack(side=tk.LEFT, padx=(5, 0))
        
        # æ§åˆ¶æŒ‰é’®
        control_frame = ttk.Frame(left_frame)
        control_frame.pack(fill=tk.X)
        
        self.start_btn = ttk.Button(control_frame, text="å¼€å§‹å…±äº«", command=self.start_sharing)
        self.start_btn.pack(side=tk.LEFT, padx=(0, 5))
        
        self.stop_btn = ttk.Button(control_frame, text="åœæ­¢å…±äº«", command=self.stop_sharing, state=tk.DISABLED)
        self.stop_btn.pack(side=tk.LEFT, padx=(0, 5))
        
        self.open_btn = ttk.Button(control_frame, text="æ‰“å¼€æµè§ˆå™¨", command=self.open_browser, state=tk.DISABLED)
        self.open_btn.pack(side=tk.LEFT)
        
        # å³ä¾§é¢æ¿ - çŠ¶æ€ä¿¡æ¯
        right_frame = ttk.LabelFrame(main_frame, text="çŠ¶æ€ä¿¡æ¯", padding=10)
        right_frame.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True, padx=(5, 0))
        
        # çŠ¶æ€æ˜¾ç¤º
        self.status_var = tk.StringVar(value="å°±ç»ª")
        status_label = ttk.Label(right_frame, text="çŠ¶æ€:", style='Header.TLabel')
        status_label.pack(anchor=tk.W)
        
        self.status_display = ttk.Label(right_frame, textvariable=self.status_var, style='Status.TLabel')
        self.status_display.pack(anchor=tk.W, pady=(0, 10))
        
        # IPåœ°å€æ˜¾ç¤º
        ip_label = ttk.Label(right_frame, text="æœ¬æœºIPåœ°å€:", style='Header.TLabel')
        ip_label.pack(anchor=tk.W)
        
        self.ip_var = tk.StringVar(value=self.get_local_ip())
        ip_display = ttk.Label(right_frame, textvariable=self.ip_var, style='Status.TLabel')
        ip_display.pack(anchor=tk.W, pady=(0, 10))
        
        # è®¿é—®åœ°å€æ˜¾ç¤º
        self.url_label = ttk.Label(right_frame, text="è®¿é—®åœ°å€:", style='Header.TLabel')
        self.url_label.pack(anchor=tk.W)
        
        self.url_var = tk.StringVar(value="æœªå¯åŠ¨æœåŠ¡")
        self.url_display = ttk.Label(right_frame, textvariable=self.url_var, style='Status.TLabel', foreground='blue', cursor='hand2')
        self.url_display.pack(anchor=tk.W, pady=(0, 10))
        self.url_display.bind("<Button-1>", lambda e: self.open_browser())
        
        # æ—¥å¿—æ˜¾ç¤º
        log_label = ttk.Label(right_frame, text="è¿è¡Œæ—¥å¿—:", style='Header.TLabel')
        log_label.pack(anchor=tk.W)
        
        self.log_text = scrolledtext.ScrolledText(right_frame, height=15, width=40, font=('Consolas', 8))
        self.log_text.pack(fill=tk.BOTH, expand=True)
        
        self.log("ç¨‹åºå¯åŠ¨å®Œæˆ")
        self.log(f"æœ¬æœºIPåœ°å€: {self.get_local_ip()}")
    
    def get_local_ip(self):
        """è·å–æœ¬æœºIPåœ°å€"""
        try:
            # è¿æ¥åˆ°ä¸€ä¸ªè¿œç¨‹åœ°å€æ¥è·å–æœ¬æœºIP
            s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
            s.connect(("8.8.8.8", 80))
            ip = s.getsockname()[0]
            s.close()
            return ip
        except:
            return "127.0.0.1"
    
    def log(self, message):
        """æ·»åŠ æ—¥å¿—ä¿¡æ¯"""
        import datetime
        timestamp = datetime.datetime.now().strftime("%H:%M:%S")
        log_message = f"[{timestamp}] {message}\n"
        
        self.log_text.insert(tk.END, log_message)
        self.log_text.see(tk.END)
        self.root.update_idletasks()
    
    def add_folder(self):
        """æ·»åŠ æ–‡ä»¶å¤¹åˆ°å…±äº«åˆ—è¡¨"""
        if self.is_sharing:
            messagebox.showwarning("è­¦å‘Š", "è¯·å…ˆåœæ­¢å…±äº«åå†æ·»åŠ æ–‡ä»¶å¤¹")
            return
        
        folder_path = filedialog.askdirectory(title="é€‰æ‹©è¦å…±äº«çš„æ–‡ä»¶å¤¹")
        if folder_path:
            if folder_path not in self.shared_folders:
                self.shared_folders.append(folder_path)
                self.folders_listbox.insert(tk.END, folder_path)
                self.log(f"æ·»åŠ å…±äº«æ–‡ä»¶å¤¹: {folder_path}")
            else:
                messagebox.showinfo("æç¤º", "è¯¥æ–‡ä»¶å¤¹å·²ç»åœ¨å…±äº«åˆ—è¡¨ä¸­")
    
    def remove_folder(self):
        """ç§»é™¤é€‰ä¸­çš„æ–‡ä»¶å¤¹"""
        if self.is_sharing:
            messagebox.showwarning("è­¦å‘Š", "è¯·å…ˆåœæ­¢å…±äº«åå†ç§»é™¤æ–‡ä»¶å¤¹")
            return
        
        selection = self.folders_listbox.curselection()
        if selection:
            index = selection[0]
            folder_path = self.shared_folders[index]
            self.shared_folders.pop(index)
            self.folders_listbox.delete(index)
            self.log(f"ç§»é™¤å…±äº«æ–‡ä»¶å¤¹: {folder_path}")
        else:
            messagebox.showinfo("æç¤º", "è¯·å…ˆé€‰æ‹©è¦ç§»é™¤çš„æ–‡ä»¶å¤¹")
    
    def clear_folders(self):
        """æ¸…ç©ºæ–‡ä»¶å¤¹åˆ—è¡¨"""
        if self.is_sharing:
            messagebox.showwarning("è­¦å‘Š", "è¯·å…ˆåœæ­¢å…±äº«åå†æ¸…ç©ºåˆ—è¡¨")
            return
        
        if self.shared_folders:
            self.shared_folders.clear()
            self.folders_listbox.delete(0, tk.END)
            self.log("æ¸…ç©ºå…±äº«æ–‡ä»¶å¤¹åˆ—è¡¨")
    
    def start_sharing(self):
        """å¼€å§‹å…±äº«"""
        if not self.shared_folders:
            messagebox.showwarning("è­¦å‘Š", "è¯·å…ˆæ·»åŠ è¦å…±äº«çš„æ–‡ä»¶å¤¹")
            return
        
        try:
            self.port = int(self.port_var.get())
            if self.port < 1024 or self.port > 65535:
                raise ValueError("ç«¯å£å·èŒƒå›´åº”ä¸º1024-65535")
        except ValueError as e:
            messagebox.showerror("é”™è¯¯", f"ç«¯å£å·è®¾ç½®é”™è¯¯: {e}")
            return
        
        try:
            # åˆ›å»ºHTTPæœåŠ¡å™¨
            self.server = CustomHTTPServer(('', self.port), CustomHTTPRequestHandler)
            self.server.shared_folders = self.shared_folders
            self.server.app_ref = self
            
            # åœ¨æ–°çº¿ç¨‹ä¸­å¯åŠ¨æœåŠ¡å™¨
            self.server_thread = threading.Thread(target=self.server.serve_forever, daemon=True)
            self.server_thread.start()
            
            self.is_sharing = True
            self.start_btn.config(state=tk.DISABLED)
            self.stop_btn.config(state=tk.NORMAL)
            self.open_btn.config(state=tk.NORMAL)
            
            url = f"http://{self.get_local_ip()}:{self.port}"
            self.url_var.set(url)
            self.status_var.set("å…±äº«ä¸­...")
            
            self.log(f"å¼€å§‹å…±äº«æœåŠ¡ï¼Œç«¯å£: {self.port}")
            self.log(f"è®¿é—®åœ°å€: {url}")
            self.log(f"å…±äº«æ–‡ä»¶å¤¹æ•°é‡: {len(self.shared_folders)}")
            
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"å¯åŠ¨å…±äº«æœåŠ¡å¤±è´¥: {e}")
            self.log(f"å¯åŠ¨å¤±è´¥: {e}")
    
    def stop_sharing(self):
        """åœæ­¢å…±äº«"""
        if self.server:
            self.server.shutdown()
            self.server = None
        
        if self.server_thread:
            self.server_thread = None
        
        self.is_sharing = False
        self.start_btn.config(state=tk.NORMAL)
        self.stop_btn.config(state=tk.DISABLED)
        self.open_btn.config(state=tk.DISABLED)
        
        self.url_var.set("æœªå¯åŠ¨æœåŠ¡")
        self.status_var.set("å·²åœæ­¢")
        
        self.log("åœæ­¢å…±äº«æœåŠ¡")
    
    def open_browser(self):
        """æ‰“å¼€æµè§ˆå™¨è®¿é—®å…±äº«"""
        if self.is_sharing:
            url = f"http://{self.get_local_ip()}:{self.port}"
            webbrowser.open(url)
            self.log("æ‰“å¼€æµè§ˆå™¨è®¿é—®å…±äº«")
    
    def on_closing(self):
        """ç¨‹åºå…³é—­æ—¶çš„å¤„ç†"""
        if self.is_sharing:
            self.stop_sharing()
        self.root.destroy()

class CustomHTTPServer(socketserver.TCPServer):
    allow_reuse_address = True

class CustomHTTPRequestHandler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        """å¤„ç†GETè¯·æ±‚"""
        try:
            if self.path == '/' or self.path == '':
                self.send_folder_list()
            elif self.path.startswith('/folder/'):
                folder_index = int(self.path.split('/')[2])
                if 0 <= folder_index < len(self.server.shared_folders):
                    self.browse_folder(self.server.shared_folders[folder_index])
                else:
                    self.send_error(404, "æ–‡ä»¶å¤¹ä¸å­˜åœ¨")
            elif self.path.startswith('/download/'):
                parts = self.path.split('/', 3)
                if len(parts) >= 4:
                    folder_index = int(parts[2])
                    file_path = parts[3]
                    if 0 <= folder_index < len(self.server.shared_folders):
                        full_path = os.path.join(self.server.shared_folders[folder_index], file_path)
                        self.download_file(full_path)
                    else:
                        self.send_error(404, "æ–‡ä»¶ä¸å­˜åœ¨")
                else:
                    self.send_error(404, "è·¯å¾„é”™è¯¯")
            else:
                self.send_error(404, "é¡µé¢ä¸å­˜åœ¨")
        except Exception as e:
            self.server.app_ref.log(f"è¯·æ±‚å¤„ç†é”™è¯¯: {e}")
            self.send_error(500, f"æœåŠ¡å™¨é”™è¯¯: {e}")
    
    def send_folder_list(self):
        """å‘é€æ–‡ä»¶å¤¹åˆ—è¡¨é¡µé¢"""
        html = """
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>å±€åŸŸç½‘æ–‡ä»¶å…±äº«</title>
            <style>
                body { font-family: 'Microsoft YaHei', Arial, sans-serif; margin: 40px; background: #f5f5f5; }
                .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                h1 { color: #333; text-align: center; margin-bottom: 30px; }
                .folder-item { background: #f8f9fa; margin: 10px 0; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff; }
                .folder-item:hover { background: #e9ecef; }
                .folder-name { font-weight: bold; color: #007bff; text-decoration: none; font-size: 16px; }
                .folder-path { color: #6c757d; font-size: 12px; margin-top: 5px; }
                .footer { text-align: center; margin-top: 30px; color: #6c757d; font-size: 12px; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ğŸ“ å±€åŸŸç½‘æ–‡ä»¶å…±äº«</h1>
        """
        
        for i, folder in enumerate(self.server.shared_folders):
            folder_name = os.path.basename(folder)
            html += f'''
                <div class="folder-item">
                    <a href="/folder/{i}" class="folder-name">ğŸ“‚ {folder_name}</a>
                    <div class="folder-path">è·¯å¾„: {folder}</div>
                </div>
            '''
        
        html += """
                <div class="footer">
                    <p>å±€åŸŸç½‘æ–‡ä»¶å¤¹å…±äº«å·¥å…· | è¯·åœ¨åŒä¸€ç½‘ç»œç¯å¢ƒä¸‹è®¿é—®</p>
                </div>
            </div>
        </body>
        </html>
        """
        
        self.send_response(200)
        self.send_header('Content-type', 'text/html; charset=utf-8')
        self.end_headers()
        self.wfile.write(html.encode('utf-8'))
    
    def browse_folder(self, folder_path, sub_path=""):
        """æµè§ˆæ–‡ä»¶å¤¹å†…å®¹"""
        current_path = os.path.join(folder_path, sub_path) if sub_path else folder_path
        
        if not os.path.exists(current_path):
            self.send_error(404, "è·¯å¾„ä¸å­˜åœ¨")
            return
        
        folder_index = self.server.shared_folders.index(folder_path)
        folder_name = os.path.basename(folder_path)
        
        html = f"""
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>{folder_name} - æ–‡ä»¶æµè§ˆ</title>
            <style>
                body {{ font-family: 'Microsoft YaHei', Arial, sans-serif; margin: 20px; background: #f5f5f5; }}
                .container {{ max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
                .header {{ margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #007bff; }}
                .breadcrumb {{ background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 20px; }}
                .breadcrumb a {{ color: #007bff; text-decoration: none; }}
                .breadcrumb a:hover {{ text-decoration: underline; }}
                .file-list {{ }}
                .file-item {{ display: flex; align-items: center; padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; }}
                .file-item:hover {{ background: #e9ecef; }}
                .file-icon {{ margin-right: 10px; font-size: 20px; }}
                .file-info {{ flex-grow: 1; }}
                .file-name {{ font-weight: bold; color: #333; text-decoration: none; }}
                .file-name:hover {{ color: #007bff; }}
                .file-size {{ color: #6c757d; font-size: 12px; }}
                .download-btn {{ background: #007bff; color: white; padding: 5px 10px; border: none; border-radius: 3px; text-decoration: none; font-size: 12px; }}
                .download-btn:hover {{ background: #0056b3; }}
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>ğŸ“ {folder_name}</h1>
                </div>
                
                <div class="breadcrumb">
                    <a href="/">ğŸ  é¦–é¡µ</a> / 
                    <a href="/folder/{folder_index}">ğŸ“‚ {folder_name}</a>
        """
        
        # æ·»åŠ é¢åŒ…å±‘å¯¼èˆª
        if sub_path:
            parts = sub_path.split('/')
            current_sub = ""
            for part in parts:
                if part:
                    current_sub = os.path.join(current_sub, part).replace('\\', '/')
                    html += f' / <a href="/folder/{folder_index}?path={quote(current_sub)}">ğŸ“ {part}</a>'
        
        html += """
                </div>
                
                <div class="file-list">
        """
        
        # å¦‚æœä¸æ˜¯æ ¹ç›®å½•ï¼Œæ·»åŠ è¿”å›ä¸Šçº§ç›®å½•é“¾æ¥
        if sub_path:
            parent_path = '/'.join(sub_path.split('/')[:-1]) if '/' in sub_path else ""
            parent_url = f"/folder/{folder_index}"
            if parent_path:
                parent_url += f"?path={quote(parent_path)}"
            
            html += f'''
                <div class="file-item">
                    <div class="file-icon">â¬†ï¸</div>
                    <div class="file-info">
                        <a href="{parent_url}" class="file-name">.. (è¿”å›ä¸Šçº§ç›®å½•)</a>
                    </div>
                </div>
            '''
        
        # åˆ—å‡ºç›®å½•å†…å®¹
        try:
            items = os.listdir(current_path)
            items.sort()
            
            # å…ˆæ˜¾ç¤ºæ–‡ä»¶å¤¹
            for item in items:
                item_path = os.path.join(current_path, item)
                if os.path.isdir(item_path):
                    new_sub_path = os.path.join(sub_path, item).replace('\\', '/') if sub_path else item
                    html += f'''
                        <div class="file-item">
                            <div class="file-icon">ğŸ“</div>
                            <div class="file-info">
                                <a href="/folder/{folder_index}?path={quote(new_sub_path)}" class="file-name">{item}</a>
                                <div class="file-size">æ–‡ä»¶å¤¹</div>
                            </div>
                        </div>
                    '''
            
            # å†æ˜¾ç¤ºæ–‡ä»¶
            for item in items:
                item_path = os.path.join(current_path, item)
                if os.path.isfile(item_path):
                    file_size = self.format_file_size(os.path.getsize(item_path))
                    download_path = os.path.join(sub_path, item).replace('\\', '/') if sub_path else item
                    
                    html += f'''
                        <div class="file-item">
                            <div class="file-icon">ğŸ“„</div>
                            <div class="file-info">
                                <div class="file-name">{item}</div>
                                <div class="file-size">{file_size}</div>
                            </div>
                            <a href="/download/{folder_index}/{quote(download_path)}" class="download-btn">ä¸‹è½½</a>
                        </div>
                    '''
        
        except PermissionError:
            html += '<div class="file-item"><div class="file-info">âŒ æƒé™ä¸è¶³ï¼Œæ— æ³•è®¿é—®æ­¤ç›®å½•</div></div>'
        
        html += """
                </div>
            </div>
        </body>
        </html>
        """
        
        self.send_response(200)
        self.send_header('Content-type', 'text/html; charset=utf-8')
        self.end_headers()
        self.wfile.write(html.encode('utf-8'))
    
    def download_file(self, file_path):
        """ä¸‹è½½æ–‡ä»¶"""
        if not os.path.exists(file_path) or not os.path.isfile(file_path):
            self.send_error(404, "æ–‡ä»¶ä¸å­˜åœ¨")
            return
        
        try:
            file_size = os.path.getsize(file_path)
            filename = os.path.basename(file_path)
            
            self.send_response(200)
            self.send_header('Content-Type', 'application/octet-stream')
            self.send_header('Content-Disposition', f'attachment; filename*=UTF-8\'\'{quote(filename)}')
            self.send_header('Content-Length', str(file_size))
            self.end_headers()
            
            # è®°å½•ä¸‹è½½æ—¥å¿—
            self.server.app_ref.log(f"ä¸‹è½½æ–‡ä»¶: {filename}")
            
            with open(file_path, 'rb') as f:
                while True:
                    data = f.read(8192)
                    if not data:
                        break
                    self.wfile.write(data)
        
        except Exception as e:
            self.server.app_ref.log(f"æ–‡ä»¶ä¸‹è½½é”™è¯¯: {e}")
            self.send_error(500, f"ä¸‹è½½å¤±è´¥: {e}")
    
    def format_file_size(self, size):
        """æ ¼å¼åŒ–æ–‡ä»¶å¤§å°"""
        for unit in ['B', 'KB', 'MB', 'GB']:
            if size < 1024.0:
                return f"{size:.1f} {unit}"
            size /= 1024.0
        return f"{size:.1f} TB"
    
    def log_message(self, format, *args):
        """é‡å†™æ—¥å¿—æ–¹æ³•ï¼Œå°†HTTPæ—¥å¿—å‘é€åˆ°GUI"""
        message = format % args
        if hasattr(self.server, 'app_ref'):
            self.server.app_ref.log(f"HTTP: {message}")

def main():
    # è®¾ç½®çª—å£DPIæ„ŸçŸ¥ï¼ˆWindows 10/11ï¼‰
    try:
        from ctypes import windll
        windll.shcore.SetProcessDpiAwareness(1)
    except:
        pass
    
    root = tk.Tk()
    app = FolderShareApp(root)
    root.mainloop()

if __name__ == "__main__":
    main()